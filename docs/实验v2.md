## 一、对比实验整体流程说明

目标：

- 均匀：Custom 不明显退化；
- 温和倾斜：Custom 至少不比 Hash 差；
- 极端倾斜：Custom 在合适的桶数下能明显优于 Hash，并能看到 b4/b8/b32 的差异。

下面所有命令都在项目根目录 spark-partition-strategy 下执行。

### 1. 均匀场景：uniform, p16, 2m

**目的：** 验证在完全均匀数据下，Custom 不会慢成鬼。

#### 1.1 跑 Hash / Range / Custom

```bash
# Hash, uniform, 2m, p16
code/scripts/run_hash_basic.sh \
    --input-type uniform \
    --num-records 2000000 \
    --num-partitions 16

# Range, uniform, 2m, p16
code/scripts/run_range_basic.sh \
    --input-type uniform \
    --num-records 2000000 \
    --num-partitions 16

# Custom, uniform, 2m, p16（无热点，无需拆桶，用 b1 做 sanity check）
code/scripts/run_custom_basic.sh \
    --input-type uniform \
    --num-records 2000000 \
    --num-partitions 16 \
    --hot-keys "" \
    --hot-bucket-factor 1
```

**预期文件名大致：**

- `hash_uniform_p16_2m_*.json`
- `range_uniform_p16_2m_*.json`
- `custom_uniform_hotNone_b1_p16_2m_*.json`

**观察点：**

- `task_p90_ms` / `task_p99_ms` / `job_total_ms` 三者都差不多；
- Custom 在均匀数据下不会明显慢于 Hash / Range。

---

### 2. 温和倾斜场景：skewed, p64, 5m（Hash vs Range vs Custom-b8）

**目的：** 倾斜不算极端时，Custom-b8 至少不比 Hash 差，最好略好一点。

假设 `SKEW_RATIO ≈ 0.7~0.8`，你现在的生成器就是这种级别。

#### 2.1 跑 Hash / Range / Custom（b8）

```bash
# Hash, skewed, 5m, p64
code/scripts/run_hash_basic.sh \
    --input-type skewed \
    --num-records 5000000 \
    --num-partitions 64

# Range, skewed, 5m, p64
code/scripts/run_range_basic.sh \
    --input-type skewed \
    --num-records 5000000 \
    --num-partitions 64

# Custom, skewed, 5m, p64，单热点 key=0，适中拆桶 b8
code/scripts/run_custom_basic.sh \
    --input-type skewed \
    --num-records 5000000 \
    --num-partitions 64 \
    --hot-keys "0" \
    --hot-bucket-factor 8
```

**预期文件名大致：**

- `hash_skewed_p64_5m_*.json`
- `range_skewed_p64_5m_*.json`
- `custom_skewed_hot0_b8_p64_5m_*.json`

**观察点：**

- Hash 的 `task_p99_ms` 在热点分区上会有明显 tail；
- Range 比 Hash 略好；
- Custom-b8 通过拆桶，`task_p90_ms` / `task_p99_ms` 至少不比 Hash 差，整体 `job_total_ms` 接近或略优。

---

### 3. 极端倾斜场景：skewed, p64, 5m（三种 job 对比，Custom 取 b32）

**目的：** 在我们认为“对 Custom 比较友好”的极端倾斜配置下，做一次 Hash vs Range vs Custom-b32 的正面对比，看 Custom 是否能明显优于 Hash，并且和 Range 至少打平。

我们仍然固定这组参数：

- data_type: `skewed`
- records_tag: `5m`（500万）
- partitions: `64`
- hotspot: `0`
- hot_bucket_factor（Custom）：`32`（接近 num-partitions，比 b4/b8 更激进）

#### 3.1 跑 Hash / Range / Custom-b32

```bash
# Hash, skewed, 5m, p64（极端倾斜 baseline）
code/scripts/run_hash_basic.sh \
        --input-type skewed \
        --num-records 5000000 \
        --num-partitions 64

# Range, skewed, 5m, p64
code/scripts/run_range_basic.sh \
        --input-type skewed \
        --num-records 5000000 \
        --num-partitions 64

# Custom, skewed, 5m, p64，单热点 key=0，激进拆桶 b32
code/scripts/run_custom_basic.sh \
        --input-type skewed \
        --num-records 5000000 \
        --num-partitions 64 \
        --hot-keys "0" \
        --hot-bucket-factor 32
```

**预期文件名大致：**

- `hash_skewed_p64_5m_*.json`
- `range_skewed_p64_5m_*.json`
- `custom_skewed_hot0_b32_p64_5m_*.json`

**观察点：**

- 与 Hash 对比：
    - 看 `task_p90_ms` / `task_p99_ms` 是否明显下降；
    - 看 `job_total_ms` 是否有更好的收敛（tail task 明显减少）。
- 与 Range 对比：
    - Range 已经在 key 维度做排序+range 分区，通常比 Hash 好；
    - Custom-b32 如果热点拆得足够散，在 tail 上不会比 Range 差，有机会略优。

---

### 4. 极端倾斜场景：skewed, p64, 5m（Custom b4 / b8 / b32 内部对比）

**目的：** 固定同一极端倾斜场景，仅改变桶数，对比不同桶数对 Custom 的影响。

固定：

- data_type: `skewed`
- records_tag: `5m`（500万）
- partitions: `64`
- hotspot: `0`

#### 4.1 只改桶数，跑 Custom 三组

```bash
# Custom, skewed, p64, 5m, b4
code/scripts/run_custom_basic.sh \
    --input-type skewed \
    --num-records 5000000 \
    --num-partitions 64 \
    --hot-keys "0" \
    --hot-bucket-factor 4

# Custom, skewed, p64, 5m, b8
code/scripts/run_custom_basic.sh \
    --input-type skewed \
    --num-records 5000000 \
    --num-partitions 64 \
    --hot-keys "0" \
    --hot-bucket-factor 8

# Custom, skewed, p64, 5m, b32（更激进拆桶，接近 num-partitions）
code/scripts/run_custom_basic.sh \
    --input-type skewed \
    --num-records 5000000 \
    --num-partitions 64 \
    --hot-keys "0" \
    --hot-bucket-factor 32
```

**预期文件名大致：**

- `custom_skewed_hot0_b4_p64_5m_*.json`
- `custom_skewed_hot0_b8_p64_5m_*.json`
- `custom_skewed_hot0_b32_p64_5m_*.json`

#### 4.2 如何解读

- 纵向：Hash vs Range vs Custom-b32  
  极端倾斜 + 桶数足够大时，Custom-b32 应该在 tail/task p99 和 job total 上明显优于 Hash，至少不比 Range 差。
- 横向：Custom-b4 vs b8 vs b32  
  看拆桶程度对 `task_p90_ms` / `task_p99_ms` / `job_total_ms` 的影响：
  - b4：拆桶不足，热点仍然比较集中；
  - b8：改善一些；
  - b32：在你当前算法下，热点能尽量摊到更多分区，tail 明显好看。

---

### 4. 汇总和画图流程

1. 跑完上述所有脚本后，results 下会有很多 `hash_*.json`、`range_*.json`、`custom_*.json`。
2. 汇总：

   ```bash
   cd /home/jjason/spark-partition-strategy
   python3 code/tools/summarize_results.py
   # 生成 code/results/summary_metrics.csv
   ```

3. 画图：

   ```bash
   python3 code/tools/plot_summary.py
   # 生成若干 png 到 code/results/
   ```

---

## 三、你接下来可以怎么跑

1. 按第一部分的命令，依次跑完：

   - uniform + p16 + 2m：Hash / Range / Custom-b1；
   - skewed + p64 + 5m：Hash / Range / Custom-b8；
   - skewed + p64 + 5m：Custom-b4 / b8 / b32。

2. 然后在根目录执行：

   ```bash
   python3 code/tools/summarize_results.py
   python3 code/tools/plot_summary.py
   ```

3. 到 results 下看图：

   - `task_p90_ms_uniform_2m_p16.png` 等：均匀 baseline；
    - `task_p90_ms_skewed_5m_p64_b8.png` 等：Hash vs Range vs Custom-b8；
    - `task_p90_ms_skewed_5m_p64_b32.png` 等：Hash vs Range vs Custom-b32；
    - `task_p90_ms_skewed_5m_p64_custom_buckets.png` 等：Custom-b4/b8/b32 横向对比。

如果你后面想再加别的场景（比如 `skewed, p32, 10m`），就手动在 `code/tools/plot_summary.py`  的 `scenarios`  里照着现在的格式再加一行就行，我这套逻辑会自动跟上。
